name: Build Void Repository
on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create repo directory
        run: mkdir -p repo

      - name: Create build script
        run: |
          cat > build.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail
          
          cd /workspace/void-packages

          # Copy custom packages
          mkdir -p srcpkgs
          echo "Copying custom packages..."
          for pkg in /workspace/srcpkgs/*; do
            [ -d "$pkg" ] || continue
            cp -r "$pkg" srcpkgs/
            echo "Copied $(basename $pkg)"
          done

          # Disable chroot to simplify CI
          mkdir -p etc
          echo "XBPS_ALLOW_CHROOT=no" > etc/conf

          # Bootstrap binary environment
          echo "::group::Bootstrap binary environment"
          ./xbps-src binary-bootstrap
          echo "::endgroup::"

          # Build all custom packages
          for pkg in srcpkgs/*; do
            [ -d "$pkg" ] || continue
            pkgname=$(basename "$pkg")
            echo "::group::Building $pkgname"
            ./xbps-src pkg "$pkgname"
            echo "::endgroup::"
          done

          # Copy built packages to /workspace/repo
          mkdir -p /workspace/repo
          cp hostdir/binpkgs/*/*.xbps /workspace/repo/ || echo "No packages built"
          EOF
          chmod +x build.sh

      - name: Run build in Docker
        run: |
          docker run --rm \
            -v "${{ github.workspace }}":/workspace \
            -w /workspace \
            voidlinux/voidlinux:latest \
            sh -c '
              set -eux
              
              # Install dependencies
              xbps-install -Sy xbps xbps-src git bash sudo base-devel wget curl tar gzip pkg-config

              # Clone void-packages if missing
              if [ ! -d void-packages ]; then
                git clone --depth=1 https://github.com/void-linux/void-packages.git
              fi

              # Make xbps-src executable
              chmod +x void-packages/xbps-src

              # Run build script
              /workspace/build.sh
            '

      - name: Verify repo contents
        run: |
          echo "Contents of repo directory:"
          ls -lah repo/
          if [ -z "$(ls -A repo/)" ]; then
            echo "Warning: repo directory is empty"
            echo "No packages were built" > repo/README.txt

      - name: Upload built packages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: repo
